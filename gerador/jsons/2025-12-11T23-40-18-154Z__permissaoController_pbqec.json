{
  "caminho": "../backend/modules/permissoes",
  "arquivo": "permissaoController.js",
  "conteudo": "const { Permissao, Status } = require('../../config/sequelize');\n\nmodule.exports = {\n  async criar(req, res) {\n    try {\n      const { descricao, modulo, acao } = req.body;\n\n      if (!descricao || !modulo || !acao) {\n        return res.status(400).json({ erro: 'Campos obrigatórios ausentes.' });\n      }\n\n      const chave = `${modulo}.${acao}`;\n\n      const existente = await Permissao.findOne({ where: { chave } });\n      if (existente) {\n        return res.status(400).json({ erro: 'Já existe uma permissão com essa chave.' });\n      }\n\n      const nova = await Permissao.create({\n        descricao,\n        modulo,\n        acao,\n        chave,\n        statusId: 1,\n        ativo: true\n      });\n\n      return res.status(201).json(nova);\n    } catch (err) {\n      return res.status(500).json({ erro: err.message });\n    }\n  },\n\n  async listar(req, res) {\n    try {\n      const dados = await Permissao.findAll({\n        include: [{ model: Status, as: 'status' }]\n      });\n\n      return res.json(dados);\n    } catch (err) {\n      return res.status(500).json({ erro: err.message });\n    }\n  },\n\n  async atualizar(req, res) {\n    try {\n      const { id } = req.params;\n      const { descricao, modulo, acao, ativo, statusId } = req.body;\n\n      const registro = await Permissao.findByPk(id);\n      if (!registro) {\n        return res.status(404).json({ erro: 'Registro não encontrado.' });\n      }\n\n      const campos = {};\n\n      if (descricao !== undefined) campos.descricao = descricao;\n      if (modulo !== undefined) campos.modulo = modulo;\n      if (acao !== undefined) campos.acao = acao;\n      if (statusId !== undefined) campos.statusId = statusId;\n      if (ativo !== undefined) campos.ativo = ativo;\n\n      if (modulo && acao) {\n        campos.chave = `${modulo}.${acao}`;\n        const existente = await Permissao.findOne({\n          where: { chave: campos.chave }\n        });\n        if (existente && existente.id !== registro.id) {\n          return res.status(400).json({ erro: 'Outra permissão já usa esta chave.' });\n        }\n      }\n\n      await registro.update(campos);\n\n      return res.json({ mensagem: 'Atualizado com sucesso.' });\n    } catch (err) {\n      return res.status(500).json({ erro: err.message });\n    }\n  },\n\n  async excluir(req, res) {\n    try {\n      const { id } = req.params;\n\n      const registro = await Permissao.findByPk(id);\n      if (!registro) {\n        return res.status(404).json({ erro: 'Registro não encontrado.' });\n      }\n\n      await registro.update({\n        ativo: false,\n        deletedAt: new Date()\n      });\n\n      return res.json({ mensagem: 'Excluído com sucesso.' });\n    } catch (err) {\n      return res.status(500).json({ erro: err.message });\n    }\n  }\n};"
}