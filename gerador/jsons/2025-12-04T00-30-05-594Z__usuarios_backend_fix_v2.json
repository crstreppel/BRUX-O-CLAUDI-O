[
  {
    "caminho": "../backend/modules/usuarios",
    "arquivo": "usuarioModel.js",
    "conteudo": "// ======================================================================\n// üßô‚Äç‚ôÇÔ∏è usuarioModel.js ‚Ä¢ PBQE-C V2 ‚Äì M√≥dulo Usu√°rios\n// ----------------------------------------------------------------------\nconst { DataTypes } = require('sequelize');\nconst sequelize = require('../../config/connection');\n\nconst Usuario = sequelize.define(\n  'Usuario',\n  {\n    id: {\n      type: DataTypes.UUID,\n      defaultValue: DataTypes.UUIDV4,\n      primaryKey: true,\n    },\n\n    usuario: {\n      type: DataTypes.STRING(50),\n      allowNull: false,\n      unique: true,\n    },\n\n    email: {\n      type: DataTypes.STRING(120),\n      allowNull: false,\n      unique: true,\n    },\n\n    senhaHash: {\n      type: DataTypes.STRING(255),\n      allowNull: false,\n      field: 'senha_hash',\n    },\n\n    emailVerificado: {\n      type: DataTypes.BOOLEAN,\n      allowNull: false,\n      defaultValue: false,\n      field: 'email_verificado',\n    },\n\n    emailToken: {\n      type: DataTypes.STRING(255),\n      allowNull: true,\n      field: 'email_token',\n    },\n\n    emailTokenExpiraEn: {\n      type: DataTypes.DATE,\n      allowNull: true,\n      field: 'email_token_expira_en',\n    },\n\n    emailCodigo: {\n      type: DataTypes.STRING(10),\n      allowNull: true,\n      field: 'email_codigo',\n    },\n\n    emailCodigoTentativas: {\n      type: DataTypes.INTEGER,\n      allowNull: false,\n      defaultValue: 0,\n      field: 'email_codigo_tentativas',\n    },\n\n    statusId: {\n      type: DataTypes.UUID,\n      allowNull: true,\n      field: 'status_id',\n    },\n\n    ativo: {\n      type: DataTypes.BOOLEAN,\n      allowNull: false,\n      defaultValue: true,\n    },\n\n    deletedAt: {\n      type: DataTypes.DATE,\n      allowNull: true,\n      field: 'deleted_at',\n    },\n  },\n  {\n    tableName: 'usuarios',\n    paranoid: true,\n    timestamps: true,\n    underscored: true,\n  }\n);\n\nmodule.exports = Usuario;\n"
  },
  {
    "caminho": "../backend/modules/usuarios",
    "arquivo": "usuarioController.js",
    "conteudo": "// ======================================================================\n// üßô‚Äç‚ôÇÔ∏è usuarioController.js ‚Ä¢ PBQE-C V2 ‚Äì M√≥dulo Usu√°rios\n// ----------------------------------------------------------------------\nconst Usuario = require('./usuarioModel');\nconst argon2 = require('argon2');\nconst { v4: uuidv4 } = require('uuid');\n\n// Utilit√°rios\nfunction gerarCodigo() {\n  return String(Math.floor(100000 + Math.random() * 900000)); // 6 d√≠gitos\n}\n\nfunction addHoras(horas) {\n  const d = new Date();\n  d.setHours(d.getHours() + horas);\n  return d;\n}\n\nmodule.exports = {\n  // -------------------------------------------------------------------\n  // Cadastro de usu√°rio\n  // -------------------------------------------------------------------\n  async cadastrarUsuario(req, res) {\n    try {\n      const { usuario, email, senha } = req.body;\n\n      if (!usuario || !email || !senha) {\n        return res\n          .status(400)\n          .json({ erro: 'Faltou preencher usu√°rio, email ou senha.' });\n      }\n\n      const emailNorm = email.trim().toLowerCase();\n\n      const emailExiste = await Usuario.findOne({ where: { email: emailNorm } });\n      if (emailExiste) {\n        return res.status(400).json({ erro: 'Email j√° em uso.' });\n      }\n\n      const usuarioExiste = await Usuario.findOne({ where: { usuario } });\n      if (usuarioExiste) {\n        return res.status(400).json({ erro: 'Usu√°rio j√° existe.' });\n      }\n\n      const senhaHash = await argon2.hash(senha, { type: argon2.argon2d });\n      const emailToken = uuidv4();\n      const emailCodigo = gerarCodigo();\n      const emailTokenExpiraEn = addHoras(24);\n\n      const user = await Usuario.create({\n        usuario,\n        email: emailNorm,\n        senhaHash,\n        emailVerificado: false,\n        emailToken,\n        emailTokenExpiraEn,\n        emailCodigo,\n        emailCodigoTentativas: 0,\n        statusId: null,\n        ativo: true,\n      });\n\n      console.log('=== SIMULA√á√ÉO DE EMAIL ===');\n      console.log('Link:', `/api/usuarios/confirmar-email?token=${user.emailToken}`);\n      console.log('C√≥digo:', user.emailCodigo);\n\n      return res.json({\n        sucesso: true,\n        mensagem: 'Usu√°rio criado! Verifique o e-mail para confirmar o acesso.',\n        email: user.email,\n        codigo: user.emailCodigo,\n      });\n    } catch (e) {\n      console.error('Erro em cadastrarUsuario:', e);\n      return res.status(500).json({ erro: 'Erro interno.' });\n    }\n  },\n\n  // -------------------------------------------------------------------\n  // Login por email + senha\n  // -------------------------------------------------------------------\n  async loginUsuario(req, res) {\n    try {\n      const { email, senha } = req.body;\n\n      if (!email || !senha) {\n        return res.status(400).json({ erro: 'Informe e-mail e senha.' });\n      }\n\n      const emailNorm = email.trim().toLowerCase();\n      const user = await Usuario.findOne({ where: { email: emailNorm } });\n\n      if (!user) {\n        return res.status(400).json({ erro: 'E-mail ou senha inv√°lidos.' });\n      }\n\n      const senhaOk = await argon2.verify(user.senhaHash, senha);\n      if (!senhaOk) {\n        return res.status(400).json({ erro: 'E-mail ou senha inv√°lidos.' });\n      }\n\n      if (!user.emailVerificado) {\n        return res.status(401).json({\n          ok: false,\n          motivo: 'EMAIL_NAO_VERIFICADO',\n          mensagem: 'Confirme seu e-mail antes de entrar.',\n        });\n      }\n\n      return res.json({\n        sucesso: true,\n        emailVerificado: true,\n        mensagem: 'Login autorizado!',\n      });\n    } catch (e) {\n      console.error('Erro em loginUsuario:', e);\n      return res.status(500).json({ erro: 'Erro interno.' });\n    }\n  },\n\n  // -------------------------------------------------------------------\n  // Confirma√ß√£o de e-mail por token (link)\n  // -------------------------------------------------------------------\n  async confirmarEmailPorToken(req, res) {\n    try {\n      const { token } = req.query;\n\n      if (!token) {\n        return res.status(400).json({ erro: 'Token n√£o informado.' });\n      }\n\n      const user = await Usuario.findOne({ where: { emailToken: token } });\n      if (!user) {\n        return res.status(400).json({ erro: 'Token inv√°lido.' });\n      }\n\n      if (user.emailVerificado) {\n        return res.status(400).json({ erro: 'Email j√° confirmado.' });\n      }\n\n      if (!user.emailTokenExpiraEn || user.emailTokenExpiraEn < new Date()) {\n        return res.status(400).json({ erro: 'Token expirado.' });\n      }\n\n      user.emailVerificado = true;\n      user.emailToken = null;\n      user.emailTokenExpiraEn = null;\n      user.emailCodigoTentativas = 0;\n      await user.save();\n\n      return res.json({ sucesso: true, emailVerificado: true });\n    } catch (e) {\n      console.error('Erro em confirmarEmailPorToken:', e);\n      return res.status(500).json({ erro: 'Erro interno.' });\n    }\n  },\n\n  // -------------------------------------------------------------------\n  // Confirma√ß√£o de e-mail por c√≥digo + email\n  // -------------------------------------------------------------------\n  async confirmarEmailPorCodigo(req, res) {\n    try {\n      const { email, codigo } = req.body;\n\n      if (!email || !codigo) {\n        return res\n          .status(400)\n          .json({ erro: 'Informe email e c√≥digo.' });\n      }\n\n      const emailNorm = email.trim().toLowerCase();\n      const user = await Usuario.findOne({ where: { email: emailNorm } });\n\n      if (!user) {\n        return res.status(400).json({ erro: 'Email n√£o encontrado.' });\n      }\n\n      if (user.emailVerificado) {\n        return res.status(400).json({ erro: 'Email j√° confirmado.' });\n      }\n\n      if (!user.emailTokenExpiraEn || user.emailTokenExpiraEn < new Date()) {\n        return res.status(400).json({ erro: 'C√≥digo expirado.' });\n      }\n\n      if (user.emailCodigo !== codigo) {\n        user.emailCodigoTentativas += 1;\n        await user.save();\n        return res.status(400).json({ erro: 'C√≥digo inv√°lido.' });\n      }\n\n      user.emailVerificado = true;\n      user.emailToken = null;\n      user.emailTokenExpiraEn = null;\n      user.emailCodigoTentativas = 0;\n      await user.save();\n\n      return res.json({ sucesso: true, emailVerificado: true });\n    } catch (e) {\n      console.error('Erro em confirmarEmailPorCodigo:', e);\n      return res.status(500).json({ erro: 'Erro interno.' });\n    }\n  },\n\n  // -------------------------------------------------------------------\n  // Reenvio do email/c√≥digo de confirma√ß√£o\n  // -------------------------------------------------------------------\n  async reenviarConfirmacao(req, res) {\n    try {\n      const { email } = req.body;\n\n      if (!email) {\n        return res.status(400).json({ erro: 'Informe o email.' });\n      }\n\n      const emailNorm = email.trim().toLowerCase();\n      const user = await Usuario.findOne({ where: { email: emailNorm } });\n\n      if (!user) {\n        return res.status(400).json({ erro: 'Email n√£o encontrado.' });\n      }\n\n      if (user.emailVerificado) {\n        return res.status(400).json({ erro: 'Email j√° confirmado.' });\n      }\n\n      user.emailToken = uuidv4();\n      user.emailCodigo = gerarCodigo();\n      user.emailTokenExpiraEn = addHoras(24);\n      user.emailCodigoTentativas = 0;\n      await user.save();\n\n      console.log('=== REENVIO CONFIRMA√á√ÉO ===');\n      console.log('Link:', `/api/usuarios/confirmar-email?token=${user.emailToken}`);\n      console.log('C√≥digo:', user.emailCodigo);\n\n      return res.json({\n        sucesso: true,\n        reenviado: true,\n        mensagem: 'Confirma√ß√£o reenviada.',\n      });\n    } catch (e) {\n      console.error('Erro em reenviarConfirmacao:', e);\n      return res.status(500).json({ erro: 'Erro interno.' });\n    }\n  },\n};\n"
  }
]