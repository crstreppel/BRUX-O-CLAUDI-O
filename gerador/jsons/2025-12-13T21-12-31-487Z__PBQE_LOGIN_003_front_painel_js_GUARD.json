{
  "caminho": "../backend/public/painel",
  "arquivo": "painel.js",
  "conteudo": "// ==============================\n// PBQE-C • Guard de Sessão (Hulk)\n// ==============================\nfunction clearSession() {\n  sessionStorage.removeItem(\"token\");\n  sessionStorage.removeItem(\"usuario\");\n  sessionStorage.removeItem(\"usuarioAtual\");\n\n  // limpa legado/qualquer resíduo\n  localStorage.removeItem(\"token\");\n  localStorage.removeItem(\"usuario\");\n  localStorage.removeItem(\"usuarioAtual\");\n}\n\nfunction redirectToLogin() {\n  window.location.href = \"/modules/login/login.html\";\n}\n\nfunction getToken() {\n  return sessionStorage.getItem(\"token\");\n}\n\nfunction base64UrlToBase64(str) {\n  return (str || \"\").replace(/-/g, \"+\").replace(/_/g, \"/\");\n}\n\nfunction decodeJwtPayload(token) {\n  try {\n    const parts = (token || \"\").split(\".\");\n    if (parts.length !== 3) return null;\n\n    const payload = parts[1];\n    const json = atob(base64UrlToBase64(payload));\n    return JSON.parse(json);\n  } catch {\n    return null;\n  }\n}\n\nfunction isTokenExpired(token) {\n  const payload = decodeJwtPayload(token);\n  if (!payload || !payload.exp) return false; // se não tem exp, não dá pra afirmar que expirou\n  return Date.now() >= payload.exp * 1000;\n}\n\n// Helper padrão PBQE-C: injeta Bearer + trata 401 global\nasync function apiFetch(url, options = {}) {\n  const token = getToken();\n\n  if (!token || isTokenExpired(token)) {\n    clearSession();\n    redirectToLogin();\n    throw new Error(\"Sessão inválida (token ausente/expirado).\");\n  }\n\n  const headers = new Headers(options.headers || {});\n  if (!headers.has(\"Authorization\")) headers.set(\"Authorization\", `Bearer ${token}`);\n\n  const response = await fetch(url, { ...options, headers });\n\n  if (response.status === 401) {\n    clearSession();\n    redirectToLogin();\n  }\n\n  return response;\n}\n\ndocument.addEventListener(\"DOMContentLoaded\", async () => {\n  const token = getToken();\n\n  if (!token || isTokenExpired(token)) {\n    clearSession();\n    redirectToLogin();\n    return;\n  }\n\n  // Carrega usuário salvo (ou tenta extrair do JWT)\n  let usuario = null;\n  try {\n    usuario = JSON.parse(sessionStorage.getItem(\"usuario\") || \"null\");\n  } catch {\n    usuario = null;\n  }\n\n  if (!usuario) {\n    usuario = decodeJwtPayload(token);\n    if (usuario) {\n      sessionStorage.setItem(\"usuario\", JSON.stringify(usuario));\n    }\n  }\n\n  const dashboardUser = document.getElementById(\"dashboardUser\");\n  if (dashboardUser) {\n    dashboardUser.textContent = usuario?.email || usuario?.usuario || \"Usuário\";\n  }\n\n  // NÃO é o foco desse chat, mas não vamos deixar o botão piorar o caos.\n  const logoutBtn = document.getElementById(\"logoutBtn\");\n  if (logoutBtn) {\n    logoutBtn.addEventListener(\"click\", () => {\n      clearSession();\n      redirectToLogin();\n    });\n  }\n\n  // Teste Hulk: tenta bater em rota protegida (se existir).\n  // 401 -> cai pro login. 404 -> ignora (rota pode não existir ainda).\n  try {\n    const resp = await apiFetch(\"/api/usuarios\", { method: \"GET\" });\n    if (resp.status === 404) return;\n  } catch {\n    // silencioso de propósito\n  }\n});\n\n// expõe helper pra outros scripts do painel se quiserem usar\nwindow.pbqeApiFetch = apiFetch;\n"
}
