[
  {
    "caminho": "../backend/modules/usuarios",
    "arquivo": "usuarioController.js",
    "conteudo": "// ======================================================================\n// üßô‚Äç‚ôÇÔ∏è usuarioController.js ‚Ä¢ PBQE-C V2 ‚Äì M√≥dulo Usu√°rios\n// ----------------------------------------------------------------------\nconst Usuario = require('./usuarioModel');\nconst argon2 = require('argon2');\nconst { v4: uuidv4 } = require('uuid');\n\nfunction gerarCodigo() { return String(Math.floor(100000 + Math.random() * 900000)); }\nfunction addHoras(h) { const d = new Date(); d.setHours(d.getHours() + h); return d; }\n\nmodule.exports = {\n  async cadastrarUsuario(req, res) {\n    try {\n      const { usuario, email, senha } = req.body;\n      if (!usuario || !email || !senha) return res.status(400).json({ erro: \"Faltou preencher usu√°rio, email ou senha.\" });\n      const emailNorm = email.trim().toLowerCase();\n      const emailExiste = await Usuario.findOne({ where: { email: emailNorm } });\n      if (emailExiste) return res.status(400).json({ erro: \"Email j√° em uso.\" });\n      const usuarioExiste = await Usuario.findOne({ where: { usuario } });\n      if (usuarioExiste) return res.status(400).json({ erro: \"Usu√°rio j√° existe.\" });\n      const senhaHash = await argon2.hash(senha, { type: argon2.argon2d });\n      const emailToken = uuidv4();\n      const emailCodigo = gerarCodigo();\n      const emailTokenExpiraEn = addHoras(24);\n      await Usuario.create({ usuario, email: emailNorm, senhaHash, emailVerificado: false, emailToken, emailCodigo, emailTokenExpiraEn, emailCodigoTentativas: 0, statusId: null, ativo: true });\n      console.log(\"=== SIMULA√á√ÉO DE EMAIL ===\"); console.log(\"Link:\", `/api/usuarios/confirmar-email?token=${emailToken}`); console.log(\"C√≥digo:\", emailCodigo);\n      return res.json({ sucesso: true, precisaConfirmarEmail: true, mensagem: \"Usu√°rio criado!\" });\n    } catch (e) { console.error(e); return res.status(500).json({ erro: \"Erro interno.\" }); }\n  },\n\n  async loginUsuario(req, res) {\n    try {\n      const { usuario, senha } = req.body;\n      if (!usuario || !senha) return res.status(400).json({ erro: \"Informe usu√°rio e senha.\" });\n      const user = await Usuario.findOne({ where: { usuario } });\n      if (!user) return res.status(400).json({ erro: \"Usu√°rio ou senha inv√°lidos.\" });\n      const senhaOk = await argon2.verify(user.senhaHash, senha);\n      if (!senhaOk) return res.status(400).json({ erro: \"Usu√°rio ou senha inv√°lidos.\" });\n      if (!user.emailVerificado) return res.status(401).json({ ok: false, motivo: \"EMAIL_NAO_VERIFICADO\", mensagem: \"Confirme seu email.\" });\n      return res.json({ ok: true, mensagem: \"Login autorizado!\" });\n    } catch (e) { console.error(e); return res.status(500).json({ erro: \"Erro interno.\" }); }\n  },\n\n  async confirmarEmailPorToken(req, res) {\n    try {\n      const { token } = req.query;\n      if (!token) return res.status(400).json({ erro: \"Token n√£o informado.\" });\n      const user = await Usuario.findOne({ where: { emailToken: token } });\n      if (!user) return res.status(400).json({ erro: \"Token inv√°lido.\" });\n      if (user.emailTokenExpiraEn < new Date()) return res.status(400).json({ erro: \"Token expirado.\" });\n      user.emailVerificado = true; user.emailToken = null; user.emailCodigo = null; user.emailTokenExpiraEn = null; user.emailCodigoTentativas = 0; await user.save();\n      return res.json({ sucesso: true, emailVerificado: true });\n    } catch (e) { console.error(e); return res.status(500).json({ erro: \"Erro interno.\" }); }\n  },\n\n  async confirmarEmailPorCodigo(req, res) {\n    try {\n      const { email, codigo } = req.body;\n      if (!email || !codigo) return res.status(400).json({ erro: \"Informe email e c√≥digo.\" });\n      const emailNorm = email.trim().toLowerCase();\n      const user = await Usuario.findOne({ where: { email: emailNorm } });\n      if (!user) return res.status(400).json({ erro: \"Email n√£o encontrado.\" });\n      if (user.emailVerificado) return res.status(400).json({ erro: \"Email j√° confirmado.\" });\n      if (user.emailTokenExpiraEn < new Date()) return res.status(400).json({ erro: \"C√≥digo expirado.\" });\n      if (user.emailCodigo !== codigo) {\n        user.emailCodigoTentativas++;\n        if (user.emailCodigoTentativas >= 5) { user.emailCodigo = null; user.emailToken = null; await user.save(); return res.status(400).json({ erro: \"Muitas tentativas.\" }); }\n        await user.save(); return res.status(400).json({ erro: \"C√≥digo incorreto.\" });\n      }\n      user.emailVerificado = true; user.emailToken = null; user.emailCodigo = null; user.emailTokenExpiraEn = null; user.emailCodigoTentativas = 0; await user.save();\n      return res.json({ sucesso: true, emailVerificado: true });\n    } catch (e) { console.error(e); return res.status(500).json({ erro: \"Erro interno.\" }); }\n  },\n\n  async reenviarConfirmacao(req, res) {\n    try {\n      const { email } = req.body;\n      if (!email) return res.status(400).json({ erro: \"Informe o email.\" });\n      const emailNorm = email.trim().toLowerCase();\n      const user = await Usuario.findOne({ where: { email: emailNorm } });\n      if (!user) return res.status(400).json({ erro: \"Email n√£o encontrado.\" });\n      if (user.emailVerificado) return res.status(400).json({ erro: \"Email j√° confirmado.\" });\n      user.emailToken = uuidv4(); user.emailCodigo = gerarCodigo(); user.emailTokenExpiraEn = addHoras(24); user.emailCodigoTentativas = 0;\n      await user.save(); console.log(\"=== REENVIO ===\"); console.log(\"Link:\", `/api/usuarios/confirmar-email?token=${user.emailToken}`); console.log(\"C√≥digo:\", user.emailCodigo);\n      return res.json({ sucesso: true, reenviado: true });\n    } catch (e) { console.error(e); return res.status(500).json({ erro: \"Erro interno.\" }); }\n  }\n};\n"
  }
]