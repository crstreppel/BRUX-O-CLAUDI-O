{
  "caminho": "../backend/modules/usuarios",
  "arquivo": "loginController.js",
  "conteudo": "const jwt = require('jsonwebtoken');\nconst bcrypt = require('bcryptjs');\nconst Usuario = require('./usuarioModel');\nconst Role = require('../roles/roleModel');\nconst Permissao = require('../permissoes/permissaoModel');\n\nmodule.exports = {\n  async login(req, res) {\n    try {\n      const { email, senha } = req.body;\n\n      if (!email || !senha) {\n        return res.status(400).json({ erro: 'E-mail e senha são obrigatórios.' });\n      }\n\n      const usuario = await Usuario.findOne({\n        where: { email },\n        include: [\n          {\n            model: Role,\n            as: 'role',\n            include: [\n              {\n                model: Permissao,\n                as: 'permissoes'\n              }\n            ]\n          }\n        ]\n      });\n\n      if (!usuario) {\n        return res.status(404).json({ erro: 'Usuário não encontrado.' });\n      }\n\n      const senhaOk = bcrypt.compareSync(senha, usuario.senha);\n      if (!senhaOk) {\n        return res.status(401).json({ erro: 'Senha inválida.' });\n      }\n\n      const permissoes = usuario.role?.permissoes?.map(p => p.chave) || [];\n\n      const payload = {\n        id: usuario.id,\n        nome: usuario.nome,\n        email: usuario.email,\n        role: usuario.role?.nome || null,\n        permissoes\n      };\n\n      const token = jwt.sign(payload, 'SEGREDO_SUPER_PBQE', {\n        expiresIn: '8h'\n      });\n\n      return res.json({\n        mensagem: 'Login efetuado com sucesso.',\n        usuario: payload,\n        token\n      });\n\n    } catch (err) {\n      return res.status(500).json({ erro: err.message });\n    }\n  }\n};\n"
}