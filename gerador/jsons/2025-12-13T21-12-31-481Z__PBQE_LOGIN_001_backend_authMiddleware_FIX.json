{
  "caminho": "../backend/modules/guard",
  "arquivo": "authMiddleware.js",
  "conteudo": "const jwt = require('jsonwebtoken');\nconst Usuario = require('../usuarios/usuarioModel');\nconst Role = require('../roles/roleModel');\nconst Permissao = require('../permissoes/permissaoModel');\n\n// Segredo JWT centralizado (PBQE-C)\nconst JWT_SECRET = require('../../config/auth').jwtSecret;\n\nmodule.exports = async function (req, res, next) {\n  try {\n    const authHeader = req.headers['authorization'];\n\n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      return res.status(401).json({ erro: 'Token não fornecido.' });\n    }\n\n    const token = authHeader.split(' ')[1];\n    if (!token) {\n      return res.status(401).json({ erro: 'Token inválido.' });\n    }\n\n    let decoded;\n    try {\n      decoded = jwt.verify(token, JWT_SECRET);\n    } catch (err) {\n      return res.status(401).json({ erro: 'Token expirado ou inválido.' });\n    }\n\n    const usuario = await Usuario.findByPk(decoded.id, {\n      include: [\n        {\n          model: Role,\n          as: 'role',\n          include: [\n            {\n              model: Permissao,\n              as: 'permissoes'\n            }\n          ]\n        }\n      ]\n    });\n\n    if (!usuario) {\n      return res.status(401).json({ erro: 'Usuário não encontrado.' });\n    }\n\n    if (!usuario.ativo) {\n      return res.status(403).json({ erro: 'Usuário inativo.' });\n    }\n\n    const permissoes = usuario.role?.permissoes?.map(p => p.chave) || [];\n\n    req.usuario = {\n      id: usuario.id,\n      usuario: usuario.usuario,\n      email: usuario.email,\n      role: usuario.role?.nome || null,\n      permissoes\n    };\n\n    return next();\n  } catch (err) {\n    return res.status(500).json({ erro: err.message });\n  }\n};\n"
}
