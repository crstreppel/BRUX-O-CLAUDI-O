{"caminho": "../backend/public/modules/roles", "arquivo": "roles.js", "conteudo": "(() => {\n  let roles = [];\n  let roleEditando = null;\n  let rolePermissaoAtual = null;\n\n  const els = {\n    nome: document.getElementById('nome'),\n    descricao: document.getElementById('descricao'),\n    statusId: document.getElementById('statusId'),\n    ativo: document.getElementById('ativo'),\n    btnSalvar: document.getElementById('btn-salvar'),\n    btnCancelar: document.getElementById('btn-cancelar'),\n    btnAtualizar: document.getElementById('btn-atualizar'),\n    tbody: document.getElementById('tbody-roles'),\n    msg: document.getElementById('msg'),\n    badgeEdit: document.getElementById('role-editing-badge'),\n    cardPerms: document.getElementById('card-permissoes'),\n    permsRoleNome: document.getElementById('perms-role-nome'),\n    listaPermsAtuais: document.getElementById('lista-perms-atuais'),\n    listaPermsTodas: document.getElementById('lista-perms-todas'),\n    btnFecharPerms: document.getElementById('btn-fechar-perms')\n  };\n\n  function showMsg(texto, tipo = 'ok') {\n    els.msg.textContent = texto;\n    els.msg.className = `msg ${tipo}`;\n    els.msg.style.display = 'block';\n    setTimeout(() => (els.msg.style.display = 'none'), 3000);\n  }\n\n  function limparForm() {\n    roleEditando = null;\n    els.nome.value = '';\n    els.descricao.value = '';\n    els.statusId.value = 1;\n    els.ativo.checked = true;\n    els.btnCancelar.style.display = 'none';\n    els.badgeEdit.style.display = 'none';\n    document.getElementById('form-title').innerText = 'Nova Role';\n  }\n\n  async function listarRoles() {\n    try {\n      const data = await apiFetch('/api/roles/listar');\n      roles = data || [];\n      renderTabela();\n    } catch (err) {\n      tratarErro(err);\n    }\n  }\n\n  function renderTabela() {\n    els.tbody.innerHTML = '';\n    roles.forEach(r => {\n      const tr = document.createElement('tr');\n      tr.innerHTML = `\n        <td>${r.id}</td>\n        <td>${r.nome}</td>\n        <td>${r.descricao}</td>\n        <td>${r.ativo ? 'Sim' : 'Não'}</td>\n        <td>\n          <button class=\"btn btn-mini\" data-acao=\"editar\">Editar</button>\n          <button class=\"btn btn-mini\" data-acao=\"perms\">Permissões</button>\n          <button class=\"btn btn-mini btn-danger\" data-acao=\"excluir\">Excluir</button>\n        </td>\n      `;\n\n      tr.querySelector('[data-acao=\"editar\"]').onclick = () => editarRole(r);\n      tr.querySelector('[data-acao=\"perms\"]').onclick = () => abrirPermissoes(r);\n      tr.querySelector('[data-acao=\"excluir\"]').onclick = () => excluirRole(r.id);\n\n      els.tbody.appendChild(tr);\n    });\n  }\n\n  async function salvarRole() {\n    const payload = {\n      nome: els.nome.value.trim(),\n      descricao: els.descricao.value.trim(),\n      statusId: Number(els.statusId.value)\n    };\n\n    try {\n      if (roleEditando) {\n        payload.ativo = els.ativo.checked;\n        await apiFetch(`/api/roles/atualizar/${roleEditando.id}`, {\n          method: 'PUT',\n          body: JSON.stringify(payload)\n        });\n        showMsg('Role atualizada com sucesso');\n      } else {\n        await apiFetch('/api/roles/criar', {\n          method: 'POST',\n          body: JSON.stringify(payload)\n        });\n        showMsg('Role criada com sucesso');\n      }\n      limparForm();\n      listarRoles();\n    } catch (err) {\n      tratarErro(err);\n    }\n  }\n\n  function editarRole(role) {\n    roleEditando = role;\n    els.nome.value = role.nome;\n    els.descricao.value = role.descricao;\n    els.statusId.value = role.statusId || 1;\n    els.ativo.checked = !!role.ativo;\n    els.btnCancelar.style.display = 'inline-block';\n    els.badgeEdit.style.display = 'inline-block';\n    document.getElementById('form-title').innerText = 'Editar Role';\n  }\n\n  async function excluirRole(id) {\n    if (!confirm('Confirma exclusão desta role?')) return;\n    try {\n      await apiFetch(`/api/roles/excluir/${id}`, { method: 'DELETE' });\n      showMsg('Role excluída');\n      listarRoles();\n    } catch (err) {\n      tratarErro(err);\n    }\n  }\n\n  async function abrirPermissoes(role) {\n    rolePermissaoAtual = role;\n    els.cardPerms.style.display = 'block';\n    els.permsRoleNome.innerText = role.nome;\n    await carregarPermissoes();\n  }\n\n  async function carregarPermissoes() {\n    try {\n      const atuais = await apiFetch(`/api/roles/${rolePermissaoAtual.id}/permissoes`);\n      const todas = await apiFetch('/api/permissoes/listar');\n      renderPermissoes(atuais.permissoes || [], todas || []);\n    } catch (err) {\n      tratarErro(err);\n    }\n  }\n\n  function renderPermissoes(atuais, todas) {\n    els.listaPermsAtuais.innerHTML = '';\n    els.listaPermsTodas.innerHTML = '';\n\n    atuais.forEach(p => {\n      const div = document.createElement('div');\n      div.className = 'perm-item';\n      div.innerHTML = `${p.nome} <button>Remover</button>`;\n      div.querySelector('button').onclick = () => removerPermissao(p.id);\n      els.listaPermsAtuais.appendChild(div);\n    });\n\n    todas.forEach(p => {\n      const div = document.createElement('div');\n      div.className = 'perm-item';\n      div.innerHTML = `${p.nome} <button>Adicionar</button>`;\n      div.querySelector('button').onclick = () => adicionarPermissao(p.id);\n      els.listaPermsTodas.appendChild(div);\n    });\n  }\n\n  async function adicionarPermissao(permissaoId) {\n    try {\n      await apiFetch(`/api/roles/${rolePermissaoAtual.id}/permissoes/adicionar`, {\n        method: 'POST',\n        body: JSON.stringify({ permissaoId })\n      });\n      carregarPermissoes();\n    } catch (err) {\n      tratarErro(err);\n    }\n  }\n\n  async function removerPermissao(permissaoId) {\n    try {\n      await apiFetch(`/api/roles/${rolePermissaoAtual.id}/permissoes/remover`, {\n        method: 'DELETE',\n        body: JSON.stringify({ permissaoId })\n      });\n      carregarPermissoes();\n    } catch (err) {\n      tratarErro(err);\n    }\n  }\n\n  function tratarErro(err) {\n    if (err && err.erro) {\n      showMsg(err.erro, 'erro');\n      return;\n    }\n    showMsg('Erro inesperado', 'erro');\n  }\n\n  els.btnSalvar.onclick = salvarRole;\n  els.btnCancelar.onclick = limparForm;\n  els.btnAtualizar.onclick = listarRoles;\n  els.btnFecharPerms.onclick = () => (els.cardPerms.style.display = 'none');\n\n  listarRoles();\n})();"}