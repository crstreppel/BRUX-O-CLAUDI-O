{
  "caminho": "../backend/auth/authMiddleware.js",
  "arquivo": "authMiddleware.js",
  "conteudo": "const jwt = require('jsonwebtoken');\nconst { Usuario, Role, Permissao } = require('../config/sequelize');\n\nmodule.exports = async function (req, res, next) {\n  try {\n    const authHeader = req.headers['authorization'];\n    if (!authHeader) {\n      return res.status(401).json({ erro: 'Token não fornecido.' });\n    }\n\n    const token = authHeader.split(' ')[1];\n    if (!token) {\n      return res.status(401).json({ erro: 'Token inválido.' });\n    }\n\n    let decoded;\n    try {\n      decoded = jwt.verify(token, 'SEGREDO_SUPER_PBQE');\n    } catch (err) {\n      return res.status(401).json({ erro: 'Token expirado ou inválido.' });\n    }\n\n    const usuario = await Usuario.findByPk(decoded.id, {\n      include: [\n        {\n          model: Role,\n          as: 'role',\n          include: [\n            {\n              model: Permissao,\n              as: 'permissoes'\n            }\n          ]\n        }\n      ]\n    });\n\n    if (!usuario) {\n      return res.status(401).json({ erro: 'Usuário não encontrado.' });\n    }\n\n    const permissoes = usuario.role?.permissoes?.map(p => p.chave) || [];\n\n    req.usuario = {\n      id: usuario.id,\n      nome: usuario.nome,\n      email: usuario.email,\n      role: usuario.role?.nome || null,\n      permissoes\n    };\n\n    next();\n  } catch (err) {\n    return res.status(500).json({ erro: err.message });\n  }\n};"
}