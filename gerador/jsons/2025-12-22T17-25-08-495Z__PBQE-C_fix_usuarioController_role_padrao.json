[
  {
    "caminho": "../backend/modules/usuarios",
    "arquivo": "usuarioController.js",
    "conteudo": "// ======================================================================\n// üßô‚Äç‚ôÇÔ∏è usuarioController.js ‚Ä¢ PBQE-C V2 ‚Äì M√≥dulo Usu√°rios\n// ----------------------------------------------------------------------\nconst Usuario = require('./usuarioModel');\nconst Status = require('../status/statusModel');\nconst Role = require('../roles/roleModel');\nconst argon2 = require('argon2');\nconst { v4: uuidv4 } = require('uuid');\n\nfunction gerarCodigo() {\n  return String(Math.floor(100000 + Math.random() * 900000));\n}\n\nfunction addHoras(horas) {\n  const d = new Date();\n  d.setHours(d.getHours() + horas);\n  return d;\n}\n\nmodule.exports = {\n  async cadastrarUsuario(req, res) {\n    try {\n      const { usuario, email, senha } = req.body;\n\n      if (!usuario || !email || !senha) {\n        return res.status(400).json({ erro: 'Faltou preencher usu√°rio, email ou senha.' });\n      }\n\n      const emailNorm = email.trim().toLowerCase();\n\n      if (await Usuario.findOne({ where: { email: emailNorm } })) {\n        return res.status(400).json({ erro: 'Email j√° em uso.' });\n      }\n\n      if (await Usuario.findOne({ where: { usuario } })) {\n        return res.status(400).json({ erro: 'Usu√°rio j√° existe.' });\n      }\n\n      const statusAtivo = await Status.findOne({ where: { nome: 'ATIVO', ativo: true } });\n      if (!statusAtivo) {\n        return res.status(500).json({ erro: 'Status ATIVO n√£o encontrado.' });\n      }\n\n      const rolePadrao = await Role.findByPk('d521e8cb-8f5a-4c7c-b489-32f794f755ff');\n      if (!rolePadrao) {\n        return res.status(500).json({ erro: 'Role padr√£o USUARIO n√£o encontrada.' });\n      }\n\n      const senhaHash = await argon2.hash(senha, { type: argon2.argon2id });\n      const emailToken = uuidv4();\n      const emailCodigo = gerarCodigo();\n      const emailTokenExpiraEn = addHoras(24);\n\n      const user = await Usuario.create({\n        usuario,\n        email: emailNorm,\n        senhaHash,\n        emailVerificado: false,\n        emailToken,\n        emailTokenExpiraEn,\n        emailCodigo,\n        emailCodigoTentativas: 0,\n        statusId: statusAtivo.id,\n        roleId: rolePadrao.id,\n        ativo: true\n      });\n\n      console.log('=== SIMULA√á√ÉO DE EMAIL ===');\n      console.log('Link:', `/api/usuarios/confirmar-email?token=${user.emailToken}`);\n      console.log('C√≥digo:', user.emailCodigo);\n\n      return res.json({\n        sucesso: true,\n        mensagem: 'Usu√°rio criado! Verifique o e-mail para confirmar o acesso.',\n        email: user.email,\n        codigo: user.emailCodigo\n      });\n    } catch (e) {\n      console.error('Erro em cadastrarUsuario:', e);\n      return res.status(500).json({ erro: 'Erro interno.' });\n    }\n  }\n};\n"
  }
]