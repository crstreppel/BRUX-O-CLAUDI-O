[
  {
    "caminho": "../backend/public/modules/usuarios",
    "arquivo": "usuarios.js",
    "conteudo": "// ======================================================================\n// üßô‚Äç‚ôÇÔ∏è usuarios.js ‚Ä¢ PBQE-C V2 Clean Light ‚Äì Fluxo de Autentica√ß√£o\n// ----------------------------------------------------------------------\n// Respons√°vel por:\n// - Cadastro de usu√°rio\n// - Login\n// - Confirma√ß√£o de e-mail por token e por c√≥digo\n// - Reenvio de e-mail de confirma√ß√£o\n// - Navega√ß√£o entre telas de autentica√ß√£o\n// ======================================================================\n\nconst API_BASE = '/api/usuarios';\n\n// Utilit√°rio de mensagens\nfunction setMessage(elementId, message, type = 'info') {\n  const el = document.getElementById(elementId);\n  if (!el) return;\n  el.textContent = message || '';\n  el.className = 'auth-message ' + (message ? `is-${type}` : '');\n}\n\n// Utilit√°rio de POST JSON\nasync function postJSON(url, payload) {\n  const response = await fetch(url, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify(payload || {})\n  });\n\n  const data = await response.json().catch(() => ({}));\n  return { ok: response.ok, status: response.status, data };\n}\n\n// ----------------------------------------------------------------------\n// Cadastro\n// ----------------------------------------------------------------------\nasync function handleCadastro(event) {\n  event.preventDefault();\n\n  const form = event.target;\n  const usuario = form.usuario?.value?.trim();\n  const email = form.email?.value?.trim();\n  const senha = form.senha?.value || '';\n  const confirmaSenha = form.confirmaSenha?.value || '';\n\n  if (!usuario || !email || !senha || !confirmaSenha) {\n    setMessage('msgCadastro', 'Preencha todos os campos.', 'error');\n    return;\n  }\n\n  if (senha !== confirmaSenha) {\n    setMessage('msgCadastro', 'As senhas n√£o conferem.', 'error');\n    return;\n  }\n\n  setMessage('msgCadastro', 'Enviando dados...', 'info');\n\n  try {\n    const { ok, data, status } = await postJSON(`${API_BASE}/cadastrar`, {\n      usuario,\n      email,\n      senha\n    });\n\n    if (!ok) {\n      setMessage('msgCadastro', data.erro || `Erro ao cadastrar (HTTP ${status}).`, 'error');\n      return;\n    }\n\n    setMessage(\n      'msgCadastro',\n      data.mensagem || 'Usu√°rio criado! Verifique o e-mail para confirmar o acesso.',\n      'success'\n    );\n\n    // Guarda algumas infos para debug/uso futuro\n    if (data.email && data.codigo) {\n      try {\n        localStorage.setItem('ultimoEmailConfirmacao', data.email);\n        localStorage.setItem('ultimoCodigoConfirmacao', data.codigo);\n      } catch (e) {\n        console.warn('N√£o foi poss√≠vel salvar dados de confirma√ß√£o no storage:', e);\n      }\n    }\n\n    form.reset();\n  } catch (error) {\n    console.error('Erro no cadastro:', error);\n    setMessage('msgCadastro', 'Erro interno ao cadastrar usu√°rio.', 'error');\n  }\n}\n\n// ----------------------------------------------------------------------\n// Login\n// ----------------------------------------------------------------------\nasync function handleLogin(event) {\n  event.preventDefault();\n\n  const form = event.target;\n  const email = form.email?.value?.trim();\n  const senha = form.senha?.value || '';\n\n  if (!email || !senha) {\n    setMessage('msgLogin', 'Informe e-mail e senha.', 'error');\n    return;\n  }\n\n  setMessage('msgLogin', 'Autenticando...', 'info');\n\n  try {\n    const { ok, data, status } = await postJSON(`${API_BASE}/login`, {\n      email,\n      senha\n    });\n\n    if (!ok) {\n      setMessage('msgLogin', data.erro || `Falha no login (HTTP ${status}).`, 'error');\n      return;\n    }\n\n    if (!data.sucesso) {\n      setMessage('msgLogin', data.erro || 'N√£o foi poss√≠vel autenticar.', 'error');\n      return;\n    }\n\n    if (!data.emailVerificado) {\n      setMessage(\n        'msgLogin',\n        'E-mail ainda n√£o confirmado. Verifique sua caixa de entrada.',\n        'warning'\n      );\n      return;\n    }\n\n    // Login OK ‚Üí salvar usu√°rio atual e redirecionar para o painel\n    try {\n      const emailNorm = email.trim().toLowerCase();\n      sessionStorage.setItem('usuarioAtual', emailNorm);\n    } catch (e) {\n      console.warn('N√£o foi poss√≠vel salvar usuarioAtual no sessionStorage:', e);\n    }\n\n    setMessage('msgLogin', 'Login efetuado com sucesso! Redirecionando...', 'success');\n    window.location.href = '/painel';\n  } catch (error) {\n    console.error('Erro no login:', error);\n    setMessage('msgLogin', 'Erro interno ao autenticar.', 'error');\n  }\n}\n\n// ----------------------------------------------------------------------\n// Confirma√ß√£o de e-mail por token (link da simula√ß√£o)\n// ----------------------------------------------------------------------\nasync function confirmarEmailPorToken(token) {\n  if (!token) {\n    setMessage('msgConfirmacao', 'Token inv√°lido.', 'error');\n    return;\n  }\n\n  setMessage('msgConfirmacao', 'Confirmando e-mail...', 'info');\n\n  try {\n    const response = await fetch(\n      `${API_BASE}/confirmar-email?token=${encodeURIComponent(token)}`\n    );\n    const data = await response.json().catch(() => ({}));\n\n    if (!response.ok || !data.sucesso) {\n      setMessage(\n        'msgConfirmacao',\n        data.erro || `Erro ao confirmar e-mail (HTTP ${response.status}).`,\n        'error'\n      );\n      return;\n    }\n\n    setMessage(\n      'msgConfirmacao',\n      'E-mail confirmado com sucesso! Agora voc√™ j√° pode fazer login.',\n      'success'\n    );\n  } catch (error) {\n    console.error('Erro ao confirmar e-mail:', error);\n    setMessage('msgConfirmacao', 'Erro interno ao confirmar e-mail.', 'error');\n  }\n}\n\n// ----------------------------------------------------------------------\n// Confirma√ß√£o por c√≥digo + reenvio\n// ----------------------------------------------------------------------\nasync function handleConfirmacaoCodigo(event) {\n  event.preventDefault();\n\n  const form = event.target;\n  const email = form.email?.value?.trim();\n  const codigo = form.codigo?.value?.trim();\n\n  if (!email || !codigo) {\n    setMessage('msgConfirmacao', 'Informe e-mail e c√≥digo.', 'error');\n    return;\n  }\n\n  setMessage('msgConfirmacao', 'Validando c√≥digo...', 'info');\n\n  try {\n    const { ok, data, status } = await postJSON(`${API_BASE}/confirmar-codigo`, {\n      email,\n      codigo\n    });\n\n    if (!ok || !data.sucesso) {\n      setMessage(\n        'msgConfirmacao',\n        data.erro || `Erro ao confirmar (HTTP ${status}).`,\n        'error'\n      );\n      return;\n    }\n\n    setMessage(\n      'msgConfirmacao',\n      'E-mail confirmado com sucesso! Agora voc√™ pode fazer login.',\n      'success'\n    );\n  } catch (error) {\n    console.error('Erro na confirma√ß√£o por c√≥digo:', error);\n    setMessage('msgConfirmacao', 'Erro interno ao confirmar c√≥digo.', 'error');\n  }\n}\n\nasync function handleReenvio(event) {\n  event.preventDefault?.();\n\n  const emailInput = document.getElementById('emailConfirmacao');\n  const email = emailInput?.value?.trim();\n\n  if (!email) {\n    setMessage('msgConfirmacao', 'Informe o e-mail para reenviar o c√≥digo.', 'error');\n    return;\n  }\n\n  setMessage('msgConfirmacao', 'Reenviando e-mail de confirma√ß√£o...', 'info');\n\n  try {\n    const { ok, data, status } = await postJSON(`${API_BASE}/reenviar-confirmacao`, {\n      email\n    });\n\n    if (!ok || !data.sucesso) {\n      setMessage(\n        'msgConfirmacao',\n        data.erro || `Erro ao reenviar (HTTP ${status}).`,\n        'error'\n      );\n      return;\n    }\n\n    setMessage(\n      'msgConfirmacao',\n      data.mensagem || 'E-mail reenviado com sucesso. Verifique sua caixa de entrada.',\n      'success'\n    );\n  } catch (error) {\n    console.error('Erro no reenvio de e-mail:', error);\n    setMessage('msgConfirmacao', 'Erro interno ao reenviar e-mail.', 'error');\n  }\n}\n\n// ----------------------------------------------------------------------\n// Navega√ß√£o entre telas de autentica√ß√£o\n// ----------------------------------------------------------------------\nfunction setupNavigation() {\n  document.querySelectorAll('[data-nav-target]').forEach((btn) => {\n    btn.addEventListener('click', () => {\n      const target = btn.getAttribute('data-nav-target');\n      if (!target) return;\n\n      document.querySelectorAll('[data-auth-view]').forEach((view) => {\n        if (view.getAttribute('data-auth-view') === target) {\n          view.classList.remove('is-hidden');\n        } else {\n          view.classList.add('is-hidden');\n        }\n      });\n    });\n  });\n}\n\n// ----------------------------------------------------------------------\n// Inicializa√ß√£o\n// ----------------------------------------------------------------------\ndocument.addEventListener('DOMContentLoaded', () => {\n  const formCadastro = document.getElementById('formCadastro');\n  if (formCadastro) {\n    formCadastro.addEventListener('submit', handleCadastro);\n  }\n\n  const formLogin = document.getElementById('formLogin');\n  if (formLogin) {\n    formLogin.addEventListener('submit', handleLogin);\n  }\n\n  const formConfirmarCodigo = document.getElementById('formConfirmarCodigo');\n  if (formConfirmarCodigo) {\n    formConfirmarCodigo.addEventListener('submit', handleConfirmacaoCodigo);\n  }\n\n  const btnReenviar = document.getElementById('btnReenviar');\n  if (btnReenviar) {\n    btnReenviar.addEventListener('click', handleReenvio);\n  }\n\n  // Se existir token na URL da p√°gina de confirma√ß√£o, tenta confirmar automaticamente\n  const params = new URLSearchParams(window.location.search);\n  const token = params.get('token');\n  if (token) {\n    confirmarEmailPorToken(token);\n  }\n\n  setupNavigation();\n});\n"
  }
]