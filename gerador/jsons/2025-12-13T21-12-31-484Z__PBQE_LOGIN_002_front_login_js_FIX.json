{
  "caminho": "../backend/public/modules/login",
  "arquivo": "login.js",
  "conteudo": "const API_BASE = \"/api/usuarios\";\n\n// ==============================\n// PBQE-C • Sessão JWT (Hulk Mode)\n// ==============================\nfunction clearSession() {\n  sessionStorage.removeItem(\"token\");\n  sessionStorage.removeItem(\"usuario\");\n  sessionStorage.removeItem(\"usuarioAtual\");\n\n  // limpa legado/qualquer resíduo\n  localStorage.removeItem(\"token\");\n  localStorage.removeItem(\"usuario\");\n  localStorage.removeItem(\"usuarioAtual\");\n}\n\nfunction setSession({ token, usuario }) {\n  sessionStorage.setItem(\"token\", token);\n  sessionStorage.setItem(\"usuario\", JSON.stringify(usuario || null));\n\n  // mata o \"logado fantasma\" antigo\n  sessionStorage.removeItem(\"usuarioAtual\");\n  localStorage.removeItem(\"usuarioAtual\");\n}\n\nfunction getToken() {\n  return sessionStorage.getItem(\"token\");\n}\n\nfunction base64UrlToBase64(str) {\n  return (str || \"\").replace(/-/g, \"+\").replace(/_/g, \"/\");\n}\n\nfunction decodeJwtPayload(token) {\n  try {\n    const parts = (token || \"\").split(\".\");\n    if (parts.length !== 3) return null;\n\n    const payload = parts[1];\n    const json = atob(base64UrlToBase64(payload));\n    return JSON.parse(json);\n  } catch {\n    return null;\n  }\n}\n\nfunction isTokenExpired(token) {\n  const payload = decodeJwtPayload(token);\n  if (!payload || !payload.exp) return false; // se não tem exp, não dá pra afirmar que expirou\n  return Date.now() >= payload.exp * 1000;\n}\n\nfunction redirectToPainel() {\n  window.location.href = \"/painel\";\n}\n\nfunction setMessageLogin(msg, type = \"info\") {\n  const el = document.getElementById(\"msgLogin\");\n  if (!el) return;\n  el.textContent = msg || \"\";\n  el.className = \"auth-message \" + (msg ? `is-${type}` : \"\");\n}\n\nasync function postJSON(url, payload) {\n  const response = await fetch(url, {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/json\" },\n    body: JSON.stringify(payload || {})\n  });\n\n  const data = await response.json().catch(() => ({}));\n  return { ok: response.ok, status: response.status, data };\n}\n\nasync function handleLogin(event) {\n  event.preventDefault();\n\n  const form = event.target;\n  const email = form.email?.value?.trim();\n  const senha = form.senha?.value || \"\";\n\n  if (!email || !senha) {\n    setMessageLogin(\"Informe e-mail e senha.\", \"error\");\n    return;\n  }\n\n  setMessageLogin(\"Autenticando...\", \"info\");\n\n  try {\n    const { ok, data, status } = await postJSON(`${API_BASE}/login`, { email, senha });\n\n    if (!ok) {\n      setMessageLogin(data.erro || `Falha no login (HTTP ${status}).`, \"error\");\n      return;\n    }\n\n    // Backend real: { mensagem, usuario: payload, token }  (sem 'sucesso' e sem 'emailVerificado')\n    if (!data || !data.token) {\n      setMessageLogin(\"Resposta inválida do servidor (token ausente).\", \"error\");\n      return;\n    }\n\n    setSession({ token: data.token, usuario: data.usuario || null });\n\n    setMessageLogin(\"Login efetuado! Redirecionando...\", \"success\");\n    redirectToPainel();\n  } catch {\n    setMessageLogin(\"Erro interno ao autenticar.\", \"error\");\n  }\n}\n\nwindow.addEventListener(\"DOMContentLoaded\", () => {\n  // Se já tem token válido, nem perde tempo no login\n  const token = getToken();\n  if (token && !isTokenExpired(token)) {\n    redirectToPainel();\n    return;\n  }\n\n  // Se tá expirado, limpa tudo e segue\n  if (token && isTokenExpired(token)) {\n    clearSession();\n  }\n\n  const form = document.getElementById(\"formLogin\");\n  if (form) form.addEventListener(\"submit\", handleLogin);\n});\n"
}
