[
  {
    "caminho": "../gerador",
    "arquivo": "gerador_v4_sentinela.js",
    "conteudo": "// PBQE-C Gerador V4 ‚Äì Modo Sentinela Supremo‚Ñ¢ (PATCH: suporte a 'origem')\n// -----------------------------------------------------------------------------\n// Novo comportamento:\n// - Se o item possuir a chave 'origem', o Gerador copia o arquivo de origem\n//   para o destino final (caminho + arquivo), em vez de usar 'conteudo'.\n// - Mant√©m compatibilidade total com JSONs antigos.\n// -----------------------------------------------------------------------------\n\nconst fs = require(\"fs\");\nconst path = require(\"path\");\n\nconst GERADOR_ROOT = __dirname;\nconst DOWNLOADS_DIR = path.join(process.env.USERPROFILE || \"\", \"Downloads\");\nconst JSONS_HISTORY_DIR = path.join(GERADOR_ROOT, \"jsons\");\nconst LOG_DIR = path.join(GERADOR_ROOT, \"pbqe_logs\");\nconst BACKUP_DIR = path.join(GERADOR_ROOT, \"pbqe_backups\");\n\nfunction ensureDir(dir) {\n  if (!fs.existsSync(dir)) {\n    fs.mkdirSync(dir, { recursive: true });\n  }\n}\n\nensureDir(JSONS_HISTORY_DIR);\nensureDir(LOG_DIR);\nensureDir(BACKUP_DIR);\n\nconst LOG_FILE = path.join(LOG_DIR, \"gerador_v4.log\");\n\nfunction log(msg) {\n  const linha = `[${new Date().toISOString()}] ${msg}\\n`;\n  fs.appendFileSync(LOG_FILE, linha, \"utf-8\");\n}\n\nfunction sleep(ms) {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\nfunction listarJSONsDownloads() {\n  if (!DOWNLOADS_DIR || !fs.existsSync(DOWNLOADS_DIR)) {\n    console.log(\"‚ùå Pasta Downloads n√£o encontrada.\");\n    log(\"ERRO: Pasta Downloads n√£o encontrada.\");\n    return [];\n  }\n\n  return fs\n    .readdirSync(DOWNLOADS_DIR)\n    .filter((f) => f.toLowerCase().endsWith(\".json\"));\n}\n\nfunction backupIfExists(destinoFinal) {\n  if (!fs.existsSync(destinoFinal)) return;\n\n  const relPath = path.relative(GERADOR_ROOT, destinoFinal);\n  const safeRel = relPath.replace(/[\\\\\\/:]/g, \"__\");\n  const stamp = new Date().toISOString().replace(/[:.]/g, \"-\");\n  const backupName = `${stamp}__${safeRel}`;\n  const backupPath = path.join(BACKUP_DIR, backupName);\n\n  fs.copyFileSync(destinoFinal, backupPath);\n  log(`Backup criado: ${backupPath}`);\n}\n\nfunction processarJson(nomeArquivo) {\n  const fullPath = path.join(DOWNLOADS_DIR, nomeArquivo);\n  log(`Iniciando processamento do JSON: ${nomeArquivo}`);\n\n  let conteudoRaw;\n  try {\n    conteudoRaw = fs.readFileSync(fullPath, \"utf-8\");\n  } catch (err) {\n    console.log(`‚ùå Erro ao ler JSON ${nomeArquivo}:`, err.message);\n    log(`ERRO leitura JSON ${nomeArquivo}: ${err.message}`);\n    return;\n  }\n\n  let jsonData;\n  try {\n    jsonData = JSON.parse(conteudoRaw);\n  } catch (err) {\n    console.log(`‚ùå JSON inv√°lido (${nomeArquivo}). Confere o arquivo.`);\n    log(`ERRO parse JSON ${nomeArquivo}: ${err.message}`);\n    const erroDestino = path.join(JSONS_HISTORY_DIR, `erro_${nomeArquivo}`);\n    fs.renameSync(fullPath, erroDestino);\n    log(`JSON com erro movido para: ${erroDestino}`);\n    return;\n  }\n\n  const itens = Array.isArray(jsonData) ? jsonData : [jsonData];\n\n  for (const item of itens) {\n    const caminho = item.caminho || \"\";\n    const arquivo = item.arquivo || \"\";\n    const conteudo = item.conteudo ?? \"\";\n    const origem = item.origem || null;\n\n    if (!arquivo) {\n      log(`AVISO: item sem 'arquivo' no JSON ${nomeArquivo}, ignorado.`);\n      continue;\n    }\n\n    const destinoFinal = path.resolve(GERADOR_ROOT, caminho, arquivo);\n    const dirDestino = path.dirname(destinoFinal);\n\n    ensureDir(dirDestino);\n    backupIfExists(destinoFinal);\n\n    try {\n      if (origem) {\n        const origemPath = path.resolve(DOWNLOADS_DIR, origem);\n        if (!fs.existsSync(origemPath)) {\n          throw new Error(`Arquivo de origem n√£o encontrado: ${origemPath}`);\n        }\n        fs.copyFileSync(origemPath, destinoFinal);\n        log(`OK: Arquivo copiado de origem ${origemPath} -> ${destinoFinal}`);\n        console.log(`üìÑ Arquivo copiado: ${destinoFinal}`);\n      } else {\n        fs.writeFileSync(destinoFinal, conteudo, \"utf-8\");\n        log(`OK: Arquivo gerado/atualizado: ${destinoFinal}`);\n        console.log(`üìÑ Arquivo gerado/atualizado: ${destinoFinal}`);\n      }\n    } catch (err) {\n      console.log(`‚ùå Erro ao escrever arquivo ${destinoFinal}:`, err.message);\n      log(`ERRO escrita arquivo ${destinoFinal}: ${err.message}`);\n    }\n  }\n\n  const stamp = new Date().toISOString().replace(/[:.]/g, \"-\");\n  const novoNome = `${stamp}__${nomeArquivo}`;\n  const destinoJson = path.join(JSONS_HISTORY_DIR, novoNome);\n  try {\n    fs.renameSync(fullPath, destinoJson);\n    log(`JSON movido para hist√≥rico: ${destinoJson}`);\n  } catch (err) {\n    console.log(`‚ö†Ô∏è N√£o foi poss√≠vel mover ${nomeArquivo} para hist√≥rico:`, err.message);\n    log(`ERRO mover JSON ${nomeArquivo} para hist√≥rico: ${err.message}`);\n  }\n}\n\nasync function loopSentinela() {\n  console.log(\"============================================================\");\n  console.log(\"üßô‚Äç‚ôÇÔ∏è PBQE-C Gerador V4 ‚Äì Modo Sentinela Supremo‚Ñ¢\");\n  console.log(\"============================================================\");\n  console.log(`üìÇ Monitorando Downloads em: ${DOWNLOADS_DIR}`);\n  console.log(\"Pressione CTRL + C para encerrar.\\n\");\n  log(\"Sentinela iniciado.\");\n\n  let ciclo = 0;\n\n  while (true) {\n    ciclo += 1;\n    const arquivos = listarJSONsDownloads();\n\n    if (arquivos.length === 0) {\n      if (ciclo % 10 === 1) {\n        console.log(\"üß≠ Sentinela ativo. Nenhum JSON novo por enquanto...\");\n      }\n      await sleep(1000);\n      continue;\n    }\n\n    console.log(`\\nüîé ${arquivos.length} JSON(s) detectado(s). Iniciando processamento...`);\n    log(`Detectados ${arquivos.length} JSON(s) para processamento.`);\n\n    for (const nome of arquivos) {\n      console.log(`\\n‚ú® Processando: ${nome}`);\n      processarJson(nome);\n    }\n\n    console.log(\"\\n‚úÖ Lote conclu√≠do. Sentinela continua ativo.\\n\");\n    await sleep(1000);\n  }\n}\n\nloopSentinela().catch((err) => {\n  console.error(\"‚ùå Erro fatal no Sentinela:\", err);\n  log(`ERRO FATAL: ${err.message}`);\n});\n"
  }
]