{
  "caminho": "../backend/modules/usuarios",
  "arquivo": "loginController.js",
  "conteudo": "// ======================================================================\n// ðŸ§™â€â™‚ï¸ loginController.js â€¢ PBQE-C V2 â€“ AutenticaÃ§Ã£o (Argon2id)\n// ----------------------------------------------------------------------\nconst jwt = require('jsonwebtoken');\nconst Usuario = require('./usuarioModel');\nconst Role = require('../roles/roleModel');\nconst Permissao = require('../permissoes/permissaoModel');\n\n// Segredo JWT centralizado (PBQE-C)\nconst JWT_SECRET = require('../../config/auth').jwtSecret;\n\nmodule.exports = {\n  async login(req, res) {\n    try {\n      const { email, senha } = req.body;\n\n      if (!email || !senha) {\n        return res.status(400).json({ erro: 'E-mail e senha sÃ£o obrigatÃ³rios.' });\n      }\n\n      const usuario = await Usuario.findOne({\n        where: { email },\n        include: [\n          {\n            model: Role,\n            as: 'role',\n            include: [\n              {\n                model: Permissao,\n                as: 'permissoes'\n              }\n            ]\n          }\n        ]\n      });\n\n      // Resposta genÃ©rica para evitar enumeraÃ§Ã£o de usuÃ¡rios\n      if (!usuario) {\n        return res.status(401).json({ erro: 'Credenciais invÃ¡lidas.' });\n      }\n\n      if (!usuario.ativo) {\n        return res.status(403).json({ erro: 'UsuÃ¡rio inativo.' });\n      }\n\n      if (!usuario.statusId) {\n        return res.status(403).json({ erro: 'UsuÃ¡rio sem status vÃ¡lido.' });\n      }\n\n      const senhaOk = await usuario.validarSenha(senha);\n      if (!senhaOk) {\n        return res.status(401).json({ erro: 'Credenciais invÃ¡lidas.' });\n      }\n\n      const permissoes = usuario.role?.permissoes?.map(p => p.chave) || [];\n\n      const payload = {\n        id: usuario.id,\n        usuario: usuario.usuario,\n        email: usuario.email,\n        role: usuario.role?.nome || null,\n        permissoes\n      };\n\n      const token = jwt.sign(payload, JWT_SECRET, { expiresIn: '8h' });\n\n      return res.json({\n        mensagem: 'Login efetuado com sucesso.',\n        usuario: payload,\n        token\n      });\n\n    } catch (err) {\n      console.error('[PBQE-LOGIN-ERROR]', err);\n      return res.status(500).json({ erro: err.message });\n    }\n  }\n};"
}